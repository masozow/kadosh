{% extends 'kadoshapp/base.html' %}
{% load staticfiles %}
<!--se añadió la fila anterior-->
    {% block styles %}
      <link type="text/css" rel="stylesheet" href="{% static "css/formularios.css" %}"/>
    {% endblock %}

    {% block extra_scripts %}
    <script type="text/javascript">
/*Espacio para JQuery y busquedas dentro del DOM
===========================================================================*/
    var selectDefault = $("#id_cliente_idcliente").html();

    //Función que crea un selector starts-with
    $.extend($.expr[":"], {
      "starts-with": function(elem, i, data, set) {
        var text = $.trim($(elem).text()),
        term = data[3];
        // first index is 0
        return text.indexOf(term) === 0;
        },
      "ends-with": function(elem, i, data, set) {
        var text = $.trim($(elem).text()),
        term = data[3];
        // last index is last possible
        return text.lastIndexOf(term) === text.length - term.length;
        }
    });

        //Función que coloca el cursor en el textbox Nit del cliente, al momento de cargar la página
        $( document ).ready(function(){ //document indica toda la página, ready indica que ya se haya cargado el DOM
          $('input#id_nit_del_cliente').focus(); //se accede al input con el id que está después de #,
                                                 //.focus() indica que ahí se colocará el cursor
        });

        //Funcion para buscar el nit del cliente:
        $( 'input#id_nit_del_cliente' ).keyup(function(e){
          var nit = $('input#id_nit_del_cliente').val();
          if(e.keyCode=='8') //Si se borra algo, regresa el select al valor original (se hace esto porque se trababa antes)
          {
            $("#id_cliente_idcliente").html(selectDefault);
          }
          if(nit==='')
          {
          }
          else {
            $("#id_cliente_idcliente").html(selectDefault);
            $("#id_cliente_idcliente option:starts-with("+nit+")").attr('selected', true);
            if($("#id_cliente_idcliente option:starts-with("+nit+")").length==0){ //si el texto no coincide, se resetea el select
              $("#id_cliente_idcliente").html(selectDefault);
            }
          }
        });

        //Función que controla el tabindex, para pasar de Nit del cliente a Código del producto
        $( 'input#id_nit_del_cliente' ).keydown(function(e){ //Keydown es para que al presionarse la tecla haga algo.
                                                            //El parámetro "e" captura la tecla del teclado
          var keyCode = e.keyCode || e.which; //se declara una variable que capturará cualquiera de esos dos valores
          if (e.keyCode==9||e.keyCode==13) { //keycode obtiene el valor ascii de la tecla presionada
            e.preventDefault(); //previene que se realice la acción por defecto que efectuaría el navegador con esa tecla
            var text=$("#id_cliente_idcliente option:selected").text().split(' ');
            var nit = $('input#id_nit_del_cliente').val();
            if(text[0]===nit)
            {
              $('input#id_codigo_producto').focus();
            }
            else {
              $('input#id_nit_del_cliente').val('');
              $('input#id_nit_del_cliente').focus();
              $("#id_cliente_idcliente").html(selectDefault);
              alert('El cliente no existe');
            }
          }
          //$('input#id_nit_del_cliente').focus();
        });
        //Función que realiza una acción al leer código de barras
        $( 'input#id_codigo_producto' ).keydown(function(e){
          var keyCode = e.keyCode || e.which; //la propiedad wich indica la tecla o el botón que se ha presionado específicamente
                                              //puede ser del teclado o del mouse, normaliza dos eventos: event.keyCode y event.charCode
          if(e.keyCode==13)
          {
            e.preventDefault();
            obtener_producto();
            alert('Producto leído');
          }
        });

/*Espacio para Ajax
============================================================================*/

        function obtener_producto() {
          console.log("xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx");
            console.log("Se ejecuta la funcion"); // Solo se comprueba que el llamado a la funcion sea correcto
            $.ajax({
                url : "/Buscar/Producto/", // La URL que llama a la vista
                type : "POST", // Metodo http para realizar el request (peticion al servidor)
                data : { codigo_producto : $('input#id_codigo_producto').val() }, // Datos enviados con el request en formato JSON

                // Si el response es correcto (si la respuesta del servidor es correcta)
                success : function(json) {
                    $('input#id_codigo_producto').val(''); // Se limpia el campo del codigo del producto
                    console.log(json); // Se envian los datos recibidos a la consola
                    $("#talk").prepend("<li><strong>"+json.codprod.pk+"</strong> - <em> "+json.lote+"</em> - <span> "+json.desc+"</span></li>");
                    console.log("success"); // Solo se comprueba mediante la consola, que el llamado fue correcto
                },

                // Si el response no tuvo exito
                error : function(xhr,errmsg,err) {
                    $('#results').html("<div class='alert-box alert radius' data-alert>Oops! Ha ocurrido un error: "+errmsg+
                        " <a href='#' class='close'>&times;</a></div>"); // Se agrega el error al DOM
                    console.log(xhr.status + ": " + xhr.responseText); // Se envia el codigo del status y el texto que ha devuelto el response
                }
            });
        };

        //La siguiente funcion sirve para obtener un Token para el formulario y asi hacer un submit seguro

        $(function() {
            // This function gets cookie with a given name
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            var csrftoken = getCookie('csrftoken');

            //The functions below will create a header with csrftoken

            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }
            function sameOrigin(url) {
                // test that a given url is a same-origin URL
                // url could be relative or scheme relative or absolute
                var host = document.location.host; // host + port
                var protocol = document.location.protocol;
                var sr_origin = '//' + host;
                var origin = protocol + sr_origin;
                // Allow absolute or scheme relative URLs to same origin
                return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                    (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                    // or any other URL that isn't scheme relative or absolute i.e relative.
                    !(/^(\/\/|http:|https:).*/.test(url));  //El asterisco y diagonal que esta antes del punto si es necesario
            }                                                 //La diagonal asterisco que esta antes del punto, hay que quitarla
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                        // Send the token to same-origin, relative URLs only.
                        // Send the token only if the method warrants CSRF protection
                        // Using the CSRFToken value acquired earlier
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

        });
    </script>
    {% endblock %}

    {% block content %}

        <h5>Punto de Venta</h5>
        <form method="POST" class="post-form">
          {% csrf_token %}

          <div class="row">
            <div class="col l6 m12 s12">
              <label>Cliente: </label>{{ form_cliente.nit_del_cliente}}{{form_Venta.cliente_idcliente}}
            </div>

            <div class="col l6 m12 s12">
              <div class="col  s6">
<label>Vendedor: </label>{{form_Producto.empleado_idempleado}}

          </div>
        </div>
      </div>

      <div class="row">
      <div class="col l6 m12 s12">
      <label>Cantidad: </label>{{form_DetalleVenta.cantidad_venta}}
      <label>Valor: </label>{{form_Precio.valor_precio}}
      </div>
      <div class="col l6 m12 s12">
      <label for="id_codigo_producto">Código: </label>{{ form_Producto.codigo_producto }}

      <input checked="checked" class="filled-in" id="check_mostrar" name="mostrar_check" type="checkbox" />
      <label for="check_mostrar">Mostrar caracteristicas del producto:</label>

      <input checked="checked" class="filled-in" id="check_promocion" name="promocion_check" type="checkbox" />
      <label for="check_promocion">Es promocion:</label>

      </div>
      </div>


      <div class="row">
        <ul id="talk">
        <div class="divider"></div>
        <p style="color: #80bfff;"><b>Características del producto</b></p>
      <div class="col l6 m12 s12">
          <div class="col  s6">
            <label>Marca: </label>{{form_TipoProducto.marca_id_marca}}
            <label>Tipo: </label>{{form_estiloproducto.tipo_producto_idtipo_producto}}
            <label>Estilo: </label>{{form_Producto.estilo_idestilo}}
            <label for="id_talla_idtalla">Talla: </label>{{form_Producto.talla_idtalla}}
          </div>



          <div class="col  s6">
            <label>Color: </label>{{form_Producto.color_idcolor}}
            <label>Género: </label>{{form_Producto.genero_idgener}}
            <label>Combo: </label>{{form_Producto.combo_idcombo}}
          </div>

      </div>
      <div class="col l6 m12 s12">
        <div class="row">
        <div class="col s12 m6">
          <div class="card blue-grey darken-1">
            <div class="card-content white-text">
              <span class="card-title">Imagen</span>
            </div>
          </div>
        </div>
      </div>

      </div>
    </div>
    <div class="row">
        <div class="col l6 m12 s12">
<label>Descripcion: </label>{{form_InventarioProducto.producto_codigo_producto}}
</div>   </div>


            <div class="divider"></div>

            <p>
            <label>Al contado: </label>{{form_Venta.contado_venta}}
            </p>
            <div class="divider"></div>

  <div class="row">
    <p style="color: #80bfff;"><b>Promoción</b></p>
    <div class="col l6 m12 s12">
      <label>Nombre de la promocion: </label>{{form_cliente.nombre_delapromocion}}
      {{form_promocionhasproducto.promocion_idpromocion}}
    </div>
    <div class="col l6 m12 s12">
    </div>
  </div>


  <div class="divider"></div>
  <div class="row">
  <div class="divider"></div>
    <div class="col l6 m12 s12">
      <table>
        <thead>
          <tr>
              <th data-field="id">Lote</th>
              <th data-field="name">Cod</th>
              <th data-field="price">Cantidad</th>
              <th data-field="price">Descripcion</th>
              <th data-field="price">Precio</th>
              <th data-field="price">Valor parcial</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>1</td>
            <td>2</td>
            <td>Suaves sabanas...</td>
            <td>80.3</td>
            <td>160.6</td>
          </tr>
        </tbody>
          </table>
    </div>
    <div class="col l6 m12 s12">
          <button type="submit" class="save btn btn-default">Realizar Venta</button>
    </div>
  </div>








  <div class="divider"></div>
  <div class="divider"></div>

              <div id="results"></div>


              <div class="divider"></div>
              <div class="row">

                <div class="col l6 m12 s12">
              <label>Tipo de pago: </label>{{form_Venta.tipo_pago_idtipo_pago}}
                </div>
                <div class="col l6 m12 s12">
                    <label>Código de autorización: </label>{{form_cliente.codigo_autorizacion}}
                      <button type="submit" class="save btn btn-default">Anular venta</button>
                </div>
              </div>


        </form>


    {% endblock %}
